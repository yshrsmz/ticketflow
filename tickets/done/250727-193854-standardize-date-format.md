---
priority: 2
description: チケット内のcreated_at, started_at, closed_atの日付フォーマットを統一する
created_at: 2025-07-27T19:38:54+09:00
started_at: 2025-07-27T21:38:59+09:00
closed_at: 2025-07-27T22:17:03+09:00
---

# 概要

チケットシステム内で使用される日付フィールド（created_at, started_at, closed_at）のフォーマットを統一する。
現在、日付の記録方法が一貫していない可能性があるため、統一されたフォーマットを定義・実装する。

## タスク
- [x] 現在の日付フォーマットの使用状況を調査
- [x] 統一する日付フォーマットを決定（RFC3339形式を推奨）
- [x] 既存コードで日付を設定・更新している箇所を特定
- [x] 日付フォーマットを統一するための実装
- [x] 既存チケットの日付フォーマットを更新するマイグレーション機能を実装
- [x] テストを追加・更新

## 技術仕様

### 統一フォーマット
- RFC3339形式（秒単位まで）: `2006-01-02T15:04:05Z07:00`
- Go標準の `time.RFC3339` を使用
- マイクロ秒・ナノ秒は含めない
- 例: `2025-07-27T19:38:54+09:00`

### 対象フィールド
- `created_at`: チケット作成日時
- `started_at`: 作業開始日時
- `closed_at`: チケット完了日時

### 影響範囲
- ticket パッケージのYAMLフロントマター処理
- CLI コマンド（new, start, close）
- 日付の表示処理

## メモ

- 現在のコードではRFC3339形式を使用しているが、ナノ秒を含む形式（例: `2025-07-27T19:38:54.927166+09:00`）になっている
- 秒単位までに統一することで、表示がシンプルになり、比較も容易になる
- タイムゾーン情報を含むフォーマットを使用することで、異なる地域での作業にも対応可能
- `time.Format(time.RFC3339)` を使用することで、自動的に秒単位までの形式になる

## 実装の知見

### 問題の原因
- GoのYAMLライブラリ（gopkg.in/yaml.v3）は、`time.Time`型をマーシャルする際にデフォルトでナノ秒精度を含む形式で出力する
- これにより、チケットの日付が `2025-07-27T19:38:54.927166+09:00` のような形式で保存されていた

### 解決方法
1. **カスタム型の実装**
   - `RFC3339Time`と`RFC3339TimePtr`という2つのカスタム型を作成
   - `MarshalYAML`と`UnmarshalYAML`メソッドを実装して、RFC3339形式（秒単位）でのシリアライズ/デシリアライズを制御
   - YAMLでは特殊文字を含む文字列は引用符で囲まれるため、日付は `"2025-07-27T19:38:54+09:00"` の形式で保存される

2. **後方互換性の確保**
   - `UnmarshalYAML`では、RFC3339形式とRFC3339Nano形式の両方をパースできるように実装
   - これにより、既存のナノ秒を含むチケットも正しく読み込める

3. **マイグレーション機能**
   - `ticketflow migrate`コマンドを追加
   - `--dry-run`オプションで事前に変更内容を確認可能
   - 実際にナノ秒を含む日付のみを検出して更新する賢い実装

### 実装のポイント
- **型安全性**: カスタム型により、コンパイル時に正しいフォーマットが保証される
- **透過的な移行**: 既存のコードへの影響を最小限に抑えるため、`.Time`プロパティでアクセス可能に
- **テストカバレッジ**: 包括的なテストで、マーシャリング、アンマーシャリング、後方互換性を確認

### 影響範囲
- `internal/ticket/ticket.go`: Ticket構造体の日付フィールドの型変更
- `internal/ticket/manager.go`: ソート処理での日付比較
- `internal/cli/commands.go`: 日付へのアクセス方法の変更
- `internal/cli/output.go`: JSON出力での日付処理
- `cmd/ticketflow/main.go`: 表示処理での日付フォーマット
- `internal/ui/views/detail.go`: TUIでの日付表示

### 学んだこと
- GoのYAMLライブラリのデフォルト動作を理解することの重要性
- カスタムマーシャラー/アンマーシャラーを使った柔軟な型制御
- 既存データとの互換性を保ちながら、新しいフォーマットに移行する方法
- マイグレーションツールの重要性と、dry-runオプションの有用性
